{% extends 'base.html' %}
{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="text-dark fw-bold mb-0">
            <i class="fas fa-building me-2"></i>Gestión de Áreas
        </h1>
        <a href="{% url 'create_area' %}" class="btn btn-danger">
            <i class="fas fa-plus-circle me-2"></i> Nueva Área
        </a>
    </div>
    {% if area %}
    <!-- Filtros avanzados -->
    <div class="card shadow-sm mb-4">
    <div class="card-body">
        <div class="row g-3 d-flex align-items-center">
            <div class="col-md-3 text-start">
                <label for="filtroNombre" class="form-label">Buscar por nombre:</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control" id="filtroNombre" placeholder="Nombre del área">
                </div>
            </div>
            <div class="col-md-3 mx-auto">
                <label for="filtroPiso" class="form-label">Filtrar por piso:</label>
                <select class="form-select" id="filtroPiso">
                    <option value="">Todos los pisos</option>
                    {% for piso in pisos %}
                        <option value="{{ piso }}">Piso {{ piso }}</option>
                    {% endfor %}
                </select>
            </div>
            
        </div>
    </div>
</div>
    <!-- Tabla de áreas -->
    <div class="card shadow-sm">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-list-alt me-2"></i> Listado de Áreas
            </h5>
            <div>
                <button id="btnExportExcel" class="btn btn-success btn-sm me-2">
                    <i class="fas fa-file-excel me-1"></i> Excel
                </button>
                <button id="btnExportPDF" class="btn btn-danger btn-sm">
                    <i class="fas fa-file-pdf me-1"></i> PDF
                </button>
            </div>
        </div>
        <div class="table-responsive">
            <table id="tablaAreas" class="table table-hover table-striped mb-0">
                <thead class="table-dark">
                    <tr>
                        <th>#</th>
                        <th>Nombre</th>
                        <th>Tipo</th>
                        <th>Piso</th>
                        <th>Ubicación</th>
                        <th>Estado</th>
                        <th>Fecha Creación</th>
                        <th>Responsable</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for a in area %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td>
                            <a href="{% url 'area_detail' a.id %}" class="text-decoration-none fw-bold text-dark">
                                {{ a.nombre }}
                            </a>
                        </td>
                        <td>{{ a.tipo_area|default:"N/A" }}</td>
                        <td>
                            {% if a.numero_piso is not none %}
                                <span class="badge bg-secondary">
                                    {% if a.numero_piso == 0 %}Planta baja
                                    {% elif a.numero_piso == 1 %}Primero
                                    {% elif a.numero_piso == 2 %}Segundo
                                    {% elif a.numero_piso == 3 %}Tercero
                                    {% elif a.numero_piso == 4 %}Azotea
                                    {% else %}Piso {{ a.numero_piso }}{% endif %}
                                </span>
                            {% else %}
                                <span class="text-muted">N/A</span>
                            {% endif %}
                        </td>
                        <td>{{ a.ubicacion|default:"N/A" }}</td>
                        <td>
                            {% if a.estado == 'Libre' %}
                            <span class="badge bg-success">
                                <i class="fas fa-check-circle me-1"></i> {{ a.estado }}
                            </span>
                            {% elif a.estado == 'Ocupado' %}
                            <span class="badge bg-primary">
                                <i class="fas fa-user me-1"></i> {{ a.estado }}
                            </span>
                            {% elif a.estado == 'Mantenimiento' %}
                            <span class="badge bg-warning text-dark">
                                <i class="fas fa-tools me-1"></i> {{ a.estado }}
                            </span>
                            {% else %}
                            <span class="badge bg-secondary">
                                <i class="fas fa-question-circle me-1"></i> {{ a.estado|default:"Sin estado" }}
                            </span>
                            {% endif %}
                        </td>
                        <td>
                            <small class="text-muted">
                                {{ a.fecha_creacion|date:"d/m/Y" }}<br>
                                {{ a.fecha_creacion|date:"H:i" }}
                            </small>
                        </td>
                        <td>
                            {% if a.user %}
                                <span class="badge bg-info bg-opacity-10 text-info">
                                    {{ a.user.get_full_name|default:a.user.username }}
                                </span>
                            {% else %}
                                <span class="badge bg-secondary bg-opacity-10 text-secondary">
                                    Sin asignar
                                </span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="d-flex gap-2">
                                <a href="{% url 'area_detail' a.id %}" class="btn btn-sm btn-outline-primary" title="Ver detalles">
                                    <i class="fas fa-eye"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="card-footer bg-light d-flex justify-content-between align-items-center">
            <div class="text-muted">
                Mostrando <span id="registrosMostrados">{{ area|length }}</span> de {{ area|length }} registros
            </div>
        </div>
    </div>
    {% else %}
    <div class="alert alert-info text-center py-5">
        <i class="fas fa-building fa-4x text-info mb-4"></i>
        <h4 class="alert-heading fw-bold">¡No hay áreas registradas!</h4>
        <p>Parece que no has añadido ninguna área todavía.</p>
        <hr>
        <a href="{% url 'create_area' %}" class="btn btn-info mt-3">
            <i class="fas fa-plus-circle me-2"></i> Crear Primera Área
        </a>
    </div>
    {% endif %}
</div>
<!-- Incluir DataTables CSS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.2.2/css/buttons.dataTables.min.css">
<!-- Incluir jQuery y DataTables JS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.html5.min.js"></script>
<script>
$(document).ready(function() {
    console.log("Inicializando DataTable"); // Depuración
    // Logotipo en Base64 (marcador de posición, reemplaza con tu propio logotipo)
    var logoBase64 = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAMAAABHPGVmAAAAA1BMVEX///+nxBvIAAAAIElEQVRoge3BAQ0AAADCoPdPbQ8HFAAAAAAAAAAAAPgT1y0AAd9zLeQAAAAASUVORK5CYII=";
    // Mapeo de valores numéricos a nombres de piso
    var pisoMap = {
        '0': 'Planta baja',
        '1': 'Primero',
        '2': 'Segundo',
        '3': 'Tercero',
        '4': 'Azotea'
    };
    // Inicializar DataTable sin paginación
    var table = $('#tablaAreas').DataTable({
        paging: false, // Desactivar paginación
        info: false, // Desactivar el mensaje de "Showing X to Y of Z entries"
        dom: 'Bfrtip', // Incluir botones de exportación
        buttons: [
            {
                extend: 'excel',
                text: '<i class="fas fa-file-excel me-1"></i> Excel',
                className: 'btn btn-success btn-sm',
                title: 'Reporte De Áreas',
                exportOptions: {
                    columns: [0, 1, 2, 3, 4, 5, 6, 7]
                }
            },
            {
                extend: 'pdf',
                text: '<i class="fas fa-file-pdf me-1"></i> PDF',
                className: 'btn btn-danger btn-sm',
                title: 'Reporte de Áreas',
                exportOptions: {
                    columns: [0, 1, 2, 3, 4, 5, 6, 7],
                    modifier: {
                        format: {
                            body: function(data, row, column, node) {
                                if (column === 3 && data) { // Columna Piso
                                    var pisoNum = data.match(/Piso (\d+)/);
                                    if (pisoNum && pisoMap[pisoNum[1]]) {
                                        return pisoMap[pisoNum[1]];
                                    }
                                    return data;
                                }
                                return data;
                            }
                        }
                    }
                },
                customize: function(doc) {
                    // Configurar márgenes
                    doc.pageMargins = [40, 60, 40, 60];
                   
                    // Encabezado personalizado
                    doc['header'] = function(currentPage, pageCount) {
                        return {
                            table: {
                                widths: ['*', 'auto'],
                                body: [
                                    [
                                        {
                                            image: logoBase64,
                                            width: 50,
                                            alignment: 'left'
                                        },
                                        {
                                            text: 'Reporte de Áreas\n' + new Date().toLocaleDateString('es-ES', {
                                                year: 'numeric',
                                                month: 'long',
                                                day: 'numeric'
                                            }),
                                            style: 'header',
                                            alignment: 'right'
                                        }
                                    ]
                                ]
                            },
                            layout: 'noBorders',
                            margin: [40, 10]
                        };
                    };
                   
                    // Pie de página personalizado
                    doc['footer'] = function(currentPage, pageCount) {
                        return {
                            columns: [
                                {
                                    text: 'Gestión de Áreas - Empresa XYZ',
                                    alignment: 'left',
                                    style: 'footer'
                                },
                                {
                                    text: 'Página ' + currentPage.toString() + ' de ' + pageCount,
                                    alignment: 'right',
                                    style: 'footer'
                                }
                            ],
                            margin: [40, 0]
                        };
                    };
                   
                    // Estilos del documento
                    doc.styles = {
                        header: {
                            fontSize: 16,
                            bold: true,
                            color: '#1a3c6d', // Azul oscuro
                            margin: [0, 10, 0, 10]
                        },
                        footer: {
                            fontSize: 10,
                            color: '#666666',
                            margin: [0, 10]
                        },
                        tableHeader: {
                            fillColor: '#1a3c6d', // Azul oscuro para el encabezado
                            color: '#ffffff', // Texto blanco
                            bold: true,
                            fontSize: 11
                        },
                        tableBody: {
                            fontSize: 10,
                            color: '#333333'
                        }
                    };
                   
                    // Personalizar tabla
                    doc.content[1].table.widths = ['5%', '15%', '10%', '10%', '15%', '15%', '15%', '15%'];
                    doc.content[1].table.body.forEach(function(row, index) {
                        row.forEach(function(cell, colIndex) {
                            cell.alignment = 'left';
                            if (index === 0) {
                                cell.fillColor = '#1a3c6d'; // Azul oscuro para el encabezado
                                cell.color = '#ffffff';
                                cell.bold = true;
                            } else {
                                cell.fillColor = index % 2 === 0 ? '#f8f9fa' : '#ffffff'; // Alternar colores de fondo
                                // Mapear valores numéricos de piso a nombres en el PDF
                                if (colIndex === 3 && cell.text in pisoMap) {
                                    cell.text = pisoMap[cell.text];
                                }
                            }
                        });
                    });
                   
                    // Añadir título antes de la tabla
                    doc.content.splice(1, 0, {
                        text: 'Reporte de Áreas',
                        style: 'header',
                        alignment: 'center',
                        margin: [0, 0, 0, 10]
                    });
                }
            }
        ],
        language: {
            url: '//cdn.datatables.net/plug-ins/1.11.5/i18n/es-ES.json'
        },
        responsive: true
    });
   
    // Aplicar filtros
    $('#filtroNombre').on('keyup', function() {
        table.column(1).search(this.value).draw();
    });
   
    $('#filtroPiso').on('change', function() {
        var selectedValue = this.value;
        // Mapear el número seleccionado al nombre legible para buscar en la columna
        var pisoName = pisoMap[selectedValue] || '';
        table.column(3).search(pisoName).draw();
    });
   
    
   
    // Actualizar contador de registros mostrados
    table.on('draw', function() {
        $('#registrosMostrados').text(table.rows({search: 'applied'}).count());
    });
   
    // Botones personalizados para exportar
    $('#btnExportExcel').on('click', function() {
        table.button('.buttons-excel').trigger();
    });
   
    $('#btnExportPDF').on('click', function() {
        table.button('.buttons-pdf').trigger();
    });
});
</script>
<style>
    body {
        background-color: #f8f9fa;
    }
   
    .card {
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 20px;
    }
   
    .table {
        margin-bottom: 0;
    }
   
    .table thead th {
        border-bottom: 2px solid #dee2e6;
        text-transform: uppercase;
        font-size: 0.8rem;
        letter-spacing: 0.5px;
    }
   
    .table tbody tr:hover {
        background-color: rgba(0, 0, 0, 0.03);
    }
   
    .badge {
        font-weight: 500;
        padding: 0.35em 0.65em;
    }
   
    .input-group-text {
        background-color: #f8f9fa;
    }
   
    .dt-buttons {
        display: none; /* Ocultamos los botones nativos de DataTables */
    }
   
    #btnExportExcel, #btnExportPDF {
        border-radius: 4px;
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
    }
   
    @media (max-width: 768px) {
        .card-header {
            flex-direction: column;
            align-items: flex-start;
        }
       
        .card-header h5 {
            margin-bottom: 10px;
        }
       
        .card-header > div {
            margin-top: 10px;
        }
       
        .table-responsive {
            border: none;
        }
       
        .row {
            margin-bottom: 10px;
        }
       
        .col-md-6 {
            margin-bottom: 15px;
        }
    }
</style>
{% endblock %}