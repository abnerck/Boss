{% extends 'base.html' %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="text-primary fw-bold mb-0">
            <i class="fas fa-broom me-2"></i> Limpiezas Programadas
        </h1>
        <a href="{% url 'create_limpiezas' %}" class="btn btn-primary">
            <i class="fas fa-plus-circle me-2"></i> Nueva Limpieza
        </a>
    </div>

    {% if limpiezas %}
    <!-- Tarjeta de filtros -->
    <div class="card shadow-sm mb-4 border-0">
        <div class="card-body p-3">
            <div class="row g-2">
                <div class="col-md-4">
                    <label for="filtroTitulo" class="form-label small fw-bold text-muted">Buscar por título:</label>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text bg-light"><i class="fas fa-search"></i></span>
                        <input type="text" class="form-control" id="filtroTitulo" placeholder="Ej: Limpieza sala">
                    </div>
                </div>
                <div class="col-md-3">
                    <label for="filtroArea" class="form-label small fw-bold text-muted">Filtrar por área:</label>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text bg-light"><i class="fas fa-map-marker-alt"></i></span>
                        <input type="text" class="form-control" id="filtroArea" placeholder="Ej: Cocina, Oficina">
                    </div>
                </div>
                <div class="col-md-3">
                    <label for="filtroEstado" class="form-label small fw-bold text-muted">Filtrar por estado:</label>
                    <select class="form-select form-select-sm" id="filtroEstado">
                        <option value="">Todos los estados</option>
                        <option value="Pendiente">Pendiente</option>
                        <option value="En progreso">En progreso</option>
                        <option value="Completado">Completado</option>
                    </select>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button id="resetFiltros" class="btn btn-outline-secondary btn-sm w-100">
                        <i class="fas fa-undo me-1"></i> Resetear
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tarjeta principal -->
    <div class="card shadow-sm border-0 rounded-3 overflow-hidden">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center py-3">
            <h5 class="mb-0 fw-semibold">
                <i class="fas fa-clipboard-list me-2"></i> Listado de Limpiezas
            </h5>
            <div>
                <button id="btnExportExcel" class="btn btn-success btn-sm me-2">
                    <i class="fas fa-file-excel me-1"></i> Excel
                </button>
                <button id="btnExportPDF" class="btn btn-danger btn-sm">
                    <i class="fas fa-file-pdf me-1"></i> PDF
                </button>
            </div>
        </div>

        <div class="table-responsive">
            <table id="tablaLimpiezas" class="table table-hover align-middle mb-0" style="width:100%">
                <thead class="table-light">
                    <tr>
                        <th class="text-center">#</th>
                        <th>Título</th>
                        <th class="d-none d-sm-table-cell">Descripción</th>
                        <th class="text-center d-none d-md-table-cell">Área</th>
                        <th class="text-center d-none d-lg-table-cell">Responsable</th>
                        <th class="text-center">Estado</th>
                        <th class="text-center d-none d-md-table-cell">Fecha Programada</th>
                        <th class="text-center d-none d-xl-table-cell">Usuario</th>
                        <th class="text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for l in limpiezas %}
                    <tr>
                        <td class="text-center">{{ forloop.counter }}</td>
                        <td>
                            <a href="{% url 'limpieza_detail' l.id %}" class="text-decoration-none fw-bold text-dark">
                                {{ l.titulo|truncatechars:30 }}
                            </a>
                        </td>
                        <td class="d-none d-sm-table-cell">{{ l.descripcion|truncatechars:40|default:"-" }}</td>
                        <td class="text-center d-none d-md-table-cell">
                            <span class="badge bg-primary bg-opacity-10 text-primary">
                                {{ l.area|default:"-" }}
                            </span>
                        </td>
                        <td class="text-center d-none d-lg-table-cell">
                            <span class="badge bg-purple bg-opacity-10 text-purple">
                                {{ l.responsable|default:"Sin asignar" }}
                            </span>
                        </td>
                        <td class="text-center">
                            {% if l.estado == 'Completado' %}
                                <span class="badge bg-success rounded-pill py-1 px-2">
                                    <i class="fas fa-check-circle me-1"></i> {{ l.estado }}
                                </span>
                            {% elif l.estado == 'En progreso' %}
                                <span class="badge bg-primary rounded-pill py-1 px-2">
                                    <i class="fas fa-spinner fa-spin me-1"></i> {{ l.estado }}
                                </span>
                            {% else %}
                                <span class="badge bg-warning rounded-pill text-dark py-1 px-2">
                                    <i class="fas fa-clock me-1"></i> {{ l.estado|default:"Pendiente" }}
                                </span>
                            {% endif %}
                        </td>
                        <td class="text-center d-none d-md-table-cell">
                            <span class="badge bg-light text-dark border">
                                {{ l.fecha_programada|date:"d/m/Y H:i" }}
                            </span>
                        </td>
                        <td class="text-center d-none d-xl-table-cell">
                            <span class="badge bg-info bg-opacity-10 text-info">
                                {{ l.user.username|truncatechars:15 }}
                            </span>
                        </td>
                        <td class="text-center">
                            <div class="d-flex justify-content-center gap-1">
                                <a href="{% url 'limpieza_detail' l.id %}" class="btn btn-sm btn-outline-primary" 
                                   data-bs-toggle="tooltip" data-bs-placement="top" title="Ver detalles">
                                    <i class="fas fa-eye"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="card-footer bg-light py-3">
            <div class="row align-items-center">
                <div class="col-md-12">
                    <p class="mb-0 text-muted small">
                        Mostrando <span id="registrosMostrados">{{ limpiezas|length }}</span> de {{ limpiezas|length }} registros
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Sección de Gráficas -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card shadow-sm h-100 border-0">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i> Distribución por Estado</h5>
                </div>
                <div class="card-body">
                    <canvas id="estadoChart" height="250"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm h-100 border-0">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i> Limpiezas por Área</h5>
                </div>
                <div class="card-body">
                    <canvas id="areaChart" height="250"></canvas>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="alert alert-info text-center py-5 mt-4">
        <div class="py-3">
            <i class="fas fa-broom fa-4x text-info mb-4 opacity-75"></i>
            <h4 class="alert-heading fw-bold">No hay limpiezas programadas</h4>
            <p class="mb-4">Comienza agregando tu primera limpieza usando el botón superior</p>
            <hr>
            <a href="{% url 'create_limpiezas' %}" class="btn btn-info px-4">
                <i class="fas fa-plus-circle me-2"></i> Programar Primera Limpieza
            </a>
        </div>
    </div>
    {% endif %}
</div>

<!-- DataTables CSS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.2.9/css/responsive.dataTables.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.2.2/css/buttons.dataTables.min.css">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- jQuery y DataTables JS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.2.9/js/dataTables.responsive.min.js"></script>

<!-- Botones de exportación para DataTables -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.print.min.js"></script>

<script>
$(document).ready(function() {
    // Logotipo en Base64 (marcador de posición, reemplaza con tu propio logotipo)
    var logoBase64 = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAMAAABHPGVmAAAAA1BMVEX///+nxBvIAAAAIElEQVRoge3BAQ0AAADCoPdPbQ8HFAAAAAAAAAAAAPgT1y0AAd9zLeQAAAAASUVORK5CYII=";

    // Inicializar DataTable con botones de exportación
    var table = $('#tablaLimpiezas').DataTable({
        paging: false,
        info: false,
        responsive: true,
        dom: 'Bfrtip', // Incluir botones de exportación
        buttons: [
            {
                extend: 'excel',
                text: '<i class="fas fa-file-excel"></i> Excel',
                className: 'btn-success btn-sm',
                title: 'Reporte de Limpiezas Programadas',
                exportOptions: {
                    columns: [0, 1, 2, 3, 4, 5, 6, 7],
                    format: {
                        body: function (data, row, column, node) {
                            // Limpiar el contenido de las celdas para exportación
                            if (column === 3 || column === 4 || column === 5 || column === 7) { // Columnas con badges
                                return $(data).text() || data;
                            }
                            return data;
                        }
                    }
                }
            },
            {
                extend: 'pdf',
                text: '<i class="fas fa-file-pdf"></i> PDF',
                className: 'btn-danger btn-sm',
                title: 'Reporte de Limpiezas Programadas',
                exportOptions: {
                    columns: [0, 1, 2, 3, 4, 5, 6, 7],
                    format: {
                        body: function (data, row, column, node) {
                            // Limpiar el contenido de las celdas para exportación
                            if (column === 3 || column === 4 || column === 5 || column === 7) { // Columnas con badges
                                return $(data).text() || data;
                            }
                            return data;
                        }
                    }
                },
                customize: function(doc) {
                    // Configurar márgenes
                    doc.pageMargins = [40, 60, 40, 60];
                    
                    // Encabezado personalizado
                    doc['header'] = function(currentPage, pageCount) {
                        return {
                            table: {
                                widths: ['*', 'auto'],
                                body: [
                                    [
                                        {
                                            image: logoBase64,
                                            width: 50,
                                            alignment: 'left'
                                        },
                                        {
                                            text: 'Reporte de Limpiezas Programadas\n' + new Date().toLocaleDateString('es-ES', {
                                                year: 'numeric',
                                                month: 'long',
                                                day: 'numeric'
                                            }),
                                            style: 'header',
                                            alignment: 'right'
                                        }
                                    ]
                                ]
                            },
                            layout: 'noBorders',
                            margin: [40, 10]
                        };
                    };
                    
                    // Pie de página personalizado
                    doc['footer'] = function(currentPage, pageCount) {
                        return {
                            columns: [
                                {
                                    text: 'Gestión de Limpiezas - Empresa XYZ',
                                    alignment: 'left',
                                    style: 'footer'
                                },
                                {
                                    text: 'Página ' + currentPage.toString() + ' de ' + pageCount,
                                    alignment: 'right',
                                    style: 'footer'
                                }
                            ],
                            margin: [40, 0]
                        };
                    };
                    
                    // Estilos del documento
                    doc.styles = {
                        header: {
                            fontSize: 16,
                            bold: true,
                            color: '#1a3c6d', // Azul oscuro
                            margin: [0, 10, 0, 10]
                        },
                        footer: {
                            fontSize: 10,
                            color: '#666666',
                            margin: [0, 10]
                        },
                        tableHeader: {
                            fillColor: '#1a3c6d', // Azul oscuro para el encabezado
                            color: '#ffffff', // Texto blanco
                            bold: true,
                            fontSize: 11
                        },
                        tableBody: {
                            fontSize: 10,
                            color: '#333333'
                        }
                    };
                    
                    // Personalizar tabla
                    doc.content[1].table.widths = ['5%', '15%', '15%', '10%', '12%', '10%', '13%', '10%', '10%'];
                    doc.content[1].table.body.forEach(function(row, index) {
                        row.forEach(function(cell, colIndex) {
                            cell.alignment = 'left';
                            if (index === 0) {
                                cell.fillColor = '#1a3c6d'; // Azul oscuro para el encabezado
                                cell.color = '#ffffff';
                                cell.bold = true;
                            } else {
                                cell.fillColor = index % 2 === 0 ? '#f8f9fa' : '#ffffff'; // Alternar colores de fondo
                            }
                        });
                    });
                    
                    // Añadir título antes de la tabla
                    doc.content.splice(1, 0, {
                        text: 'Reporte de Limpiezas Programadas',
                        style: 'header',
                        alignment: 'center',
                        margin: [0, 0, 0, 10]
                    });
                }
            }
        ],
        language: {
            url: '//cdn.datatables.net/plug-ins/1.11.5/i18n/es-ES.json',
            search: "_INPUT_",
            searchPlaceholder: "Buscar en la tabla...",
        },
        initComplete: function() {
            $('.dataTables_filter input').addClass('form-control form-control-sm');
            $('.dataTables_filter label').contents().filter(function() {
                return this.nodeType === 3;
            }).remove();
            
            // Ocultar los botones nativos de DataTables
            $('.dt-buttons').hide();
        },
        drawCallback: function() {
            $('#registrosMostrados').text(this.page.info().recordsDisplay || {{ limpiezas|length }});
            $('[data-bs-toggle="tooltip"]').tooltip();
            updateCharts();
        }
    });

    // Inicializar gráficos
    var estadoChart = initEstadoChart();
    var areaChart = initAreaChart();
    
    // Función para inicializar el gráfico de estados
    function initEstadoChart() {
        var ctx = document.getElementById('estadoChart').getContext('2d');
        return new Chart(ctx, {
            type: 'pie',
            data: getEstadoChartData(),
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.label}: ${context.raw} (${context.formattedValue}%)`;
                            }
                        }
                    }
                }
            }
        });
    }
    
    // Función para inicializar el gráfico de áreas (CORREGIDA)
    function initAreaChart() {
        var ctx = document.getElementById('areaChart').getContext('2d');
        return new Chart(ctx, {
            type: 'bar',
            data: getAreaChartData(),
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.label}: ${context.raw}`;
                            }
                        }
                    }
                }
            }
        });
    }
    
    // Función para obtener datos para el gráfico de estados
    function getEstadoChartData() {
        var filteredData = table.rows({search: 'applied'}).data();
        var estados = ['Pendiente', 'En progreso', 'Completado'];
        var counts = [0, 0, 0];
        
        filteredData.each(function(row) {
            var estado = row[5].includes('Pendiente') ? 'Pendiente' : 
                         row[5].includes('En progreso') ? 'En progreso' : 'Completado';
            
            if (estado === 'Pendiente') counts[0]++;
            else if (estado === 'En progreso') counts[1]++;
            else if (estado === 'Completado') counts[2]++;
        });
        
        return {
            labels: estados,
            datasets: [{
                data: counts,
                backgroundColor: [
                    'rgba(255, 193, 7, 0.8)',
                    'rgba(13, 110, 253, 0.8)',
                    'rgba(25, 135, 84, 0.8)'
                ],
                borderColor: [
                    'rgba(255, 193, 7, 1)',
                    'rgba(13, 110, 253, 1)',
                    'rgba(25, 135, 84, 1)'
                ],
                borderWidth: 1
            }]
        };
    }
    
    // Función CORREGIDA para obtener datos para el gráfico de áreas
    function getAreaChartData() {
        var filteredData = table.rows({search: 'applied'}).data();
        var areas = {};
        
        filteredData.each(function(row) {
            // Extraer el área de la celda de la tabla (columna 3)
            var areaCell = row[3];
            var areaText = 'Sin área';
            
            // Si es un string, puede contener HTML
            if (typeof areaCell === 'string') {
                // Crear elemento temporal para extraer texto
                var temp = document.createElement('div');
                temp.innerHTML = areaCell;
                areaText = temp.textContent.trim() || 'Sin área';
            } 
            // Si es un objeto jQuery (si DataTables lo transformó)
            else if (areaCell && areaCell.text) {
                areaText = areaCell.text().trim() || 'Sin área';
            }
            
            if (!areas[areaText]) {
                areas[areaText] = 0;
            }
            areas[areaText]++;
        });
        
        // Convertir a array y ordenar
        var areasArray = Object.entries(areas).map(([area, count]) => {
            return { area: area, count: count };
        }).sort((a, b) => b.count - a.count);
        
        // Tomar máximo 5 áreas
        var topAreas = areasArray.slice(0, 5);
        
        // Si no hay datos, mostrar mensaje
        if (topAreas.length === 0) {
            return {
                labels: ['Sin datos'],
                datasets: [{
                    data: [1],
                    backgroundColor: ['rgba(200, 200, 200, 0.6)'],
                    borderColor: ['rgba(200, 200, 200, 1)'],
                    borderWidth: 1
                }]
            };
        }
        
        return {
            labels: topAreas.map(item => item.area),
            datasets: [{
                data: topAreas.map(item => item.count),
                backgroundColor: [
                    'rgba(54, 162, 235, 0.6)',
                    'rgba(255, 99, 132, 0.6)',
                    'rgba(75, 192, 192, 0.6)',
                    'rgba(153, 102, 255, 0.6)',
                    'rgba(255, 159, 64, 0.6)'
                ],
                borderColor: [
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 99, 132, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(153, 102, 255, 1)',
                    'rgba(255, 159, 64, 1)'
                ],
                borderWidth: 1
            }]
        };
    }
    
    // Función para actualizar todos los gráficos
    function updateCharts() {
        estadoChart.data = getEstadoChartData();
        estadoChart.update();
        
        areaChart.data = getAreaChartData();
        areaChart.update();
    }

    // Filtros personalizados
    $('#filtroTitulo').on('keyup', function() {
        table.column(1).search(this.value).draw();
    });
    
    $('#filtroArea').on('keyup', function() {
        table.column(3).search(this.value).draw();
    });
    
    $('#filtroEstado').on('change', function() {
        table.column(5).search(this.value).draw();
    });
    
    // Resetear filtros
    $('#resetFiltros').on('click', function() {
        $('#filtroTitulo, #filtroArea, #filtroEstado').val('');
        table.search('').columns().search('').draw();
    });
    
    // Botones personalizados para exportar
    $('#btnExportExcel').on('click', function() {
        table.button('.buttons-excel').trigger();
    });
    
    $('#btnExportPDF').on('click', function() {
        table.button('.buttons-pdf').trigger();
    });
    
    // Responsive para móviles
    if ($(window).width() < 768) {
        table.responsive.recalc();
    }
    
    $(window).resize(function() {
        if ($(window).width() < 768) {
            table.responsive.recalc();
        }
    });
    
    // Actualizar gráficos al cargar la página
    updateCharts();
});
</script>

<style>
    body {
        background-color: #f8f9fa;
    }
    
    .card {
        border: none;
        border-radius: 0.5rem;
        overflow: hidden;
    }
    
    .card-header {
        border-bottom: none;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .table {
        margin-bottom: 0;
        font-size: 0.875rem;
    }
    
    .table th {
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.5px;
        background-color: #f8f9fa !important;
    }
    
    .table-hover tbody tr:hover {
        background-color: rgba(13, 110, 253, 0.05);
    }
    
    .badge {
        font-weight: 500;
        padding: 0.35em 0.65em;
    }
    
    .bg-purple {
        background-color: #f7f6f8;
    }
    
    .text-purple {
        color: #000000;
    }
    
    /* Estilos para los botones de exportación */
    .dt-buttons {
        display: none; /* Ocultamos los botones nativos de DataTables */
    }
    
    #btnExportExcel, #btnExportPDF {
        border-radius: 4px;
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
    }
    
    /* Estilos para DataTables */
    .dataTables_wrapper .dataTables_filter input {
        border: 1px solid #dee2e6;
        padding: 0.375rem 0.75rem;
        margin-left: 0.5rem;
    }
    
    /* Estilos para las gráficas */
    .chart-container {
        position: relative;
        height: 100%;
        min-height: 250px;
    }
    
    /* Estilos para pantallas pequeñas */
    @media (max-width: 767.98px) {
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .dataTables_wrapper .dataTables_filter {
            text-align: center;
        }
        
        .row {
            margin-bottom: 10px;
        }
        
        .col-md-6 {
            margin-bottom: 15px;
        }
        
        .card-header {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .card-header h5 {
            margin-bottom: 10px;
        }
        
        .card-header > div {
            margin-top: 10px;
        }
    }
    
    /* Estilos para tooltips */
    .tooltip-inner {
        font-size: 0.75rem;
    }
</style>
{% endblock %}