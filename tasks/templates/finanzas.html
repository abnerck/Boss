{% extends 'base.html' %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="text-primary fw-bold mb-0">
            <i class="fas fa-wallet me-2"></i>Gestión de Finanzas
        </h1>
        <a href="{% url 'create_finanza' %}" class="btn btn-primary">
            <i class="fas fa-plus-circle me-2"></i> Nuevo Registro
        </a>
    </div>

    {% if finanza %}
    <!-- Filtros optimizados -->
    <div class="card shadow-sm mb-4 border-0" style="background-color: #f8f9fa;">
        <div class="card-body py-3">
            <div class="row g-3">
                <div class="col-md-4">
                    <label for="filtroTitulo" class="form-label fw-bold text-muted">Buscar por título:</label>
                    <div class="input-group">
                        <span class="input-group-text bg-white"><i class="fas fa-search text-muted"></i></span>
                        <input type="text" class="form-control border-start-0" id="filtroTitulo" placeholder="Título del registro">
                    </div>
                </div>
                <div class="col-md-4">
                    <label for="filtroDescripcion" class="form-label fw-bold text-muted">Buscar por descripción:</label>
                    <div class="input-group">
                        <span class="input-group-text bg-white"><i class="fas fa-search text-muted"></i></span>
                        <input type="text" class="form-control border-start-0" id="filtroDescripcion" placeholder="Descripción">
                    </div>
                </div>
                <div class="col-md-4">
                    <label for="filtroTipo" class="form-label fw-bold text-muted">Filtrar por tipo:</label>
                    <select id="filtroTipo" class="form-select">
                        <option value="">Todos</option>
                        <option value="Ingreso">Ingresos</option>
                        <option value="Gasto">Gastos</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de finanzas -->
    <div class="card shadow-sm border-0">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-clipboard-list me-2"></i> Listado de Finanzas
            </h5>
            <div>
                <button id="btnExportExcel" class="btn btn-success btn-sm">
                    <i class="fas fa-file-excel me-1"></i> Excel
                </button>
            </div>
        </div>
        
        <div class="table-responsive">
            <table id="tablaFinanzas" class="table table-hover mb-0">
                <thead class="table-dark">
                    <tr>
                        <th>#</th>
                        <th>Título</th>
                        <th>Tipo</th>
                        <th>Categoría</th>
                        <th>Monto</th>
                        <th>Fecha</th>
                        <th>Usuario</th>
                        <th>Descripción</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for f in finanza %}
                    <tr class="align-middle">
                        <td class="text-muted">{{ forloop.counter }}</td>
                        <td>
                            <a href="{% url 'finanza_detail' f.id %}" class="text-decoration-none fw-bold" 
                               style="color: {% if f.tipo == 'Ingreso' %}#2e8b57{% else %}#c23b22{% endif %}">
                                {{ f.titulo|truncatechars:25 }}
                            </a>
                        </td>
                        <td class="text-center">
                            {% if f.tipo == 'Ingreso' %}
                            <span class="badge rounded-pill" style="background-color: #e6f7ed; color: #2e8b57; border: 1px solid #2e8b57;">
                                <i class="fas fa-arrow-up me-1"></i> {{ f.tipo }}
                            </span>
                            {% elif f.tipo == 'Gasto' %}
                            <span class="badge rounded-pill" style="background-color: #fde8e5; color: #c23b22; border: 1px solid #c23b22;">
                                <i class="fas fa-arrow-down me-1"></i> {{ f.tipo }}
                            </span>
                            {% else %}
                            <span class="badge bg-secondary">
                                <i class="fas fa-exchange-alt me-1"></i> {{ f.tipo }}
                            </span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if f.categoria == 'Salario' %}
                            <span class="badge rounded-pill" style="background-color: #e6f3ff; color: #1a73e8; border: 1px solid #1a73e8;">
                                {{ f.categoria }}
                            </span>
                            {% elif f.categoria == 'Comida' %}
                            <span class="badge rounded-pill" style="background-color: #fff8e6; color: #ff9800; border: 1px solid #ff9800;">
                                {{ f.categoria }}
                            </span>
                            {% elif f.categoria == 'Transporte' %}
                            <span class="badge rounded-pill" style="background-color: #f0f4ff; color: #3f51b5; border: 1px solid #3f51b5;">
                                {{ f.categoria }}
                            </span>
                            {% elif f.categoria == 'Entretenimiento' %}
                            <span class="badge rounded-pill" style="background-color: #fce4ff; color: #9c27b0; border: 1px solid #9c27b0;">
                                {{ f.categoria }}
                            </span>
                            {% else %}
                            <span class="badge rounded-pill bg-light text-dark border border-dark-subtle">
                                {{ f.categoria|default:"General" }}
                            </span>
                            {% endif %}
                        </td>
                        <td class="text-center fw-bold {% if f.tipo == 'Ingreso' %}text-success{% else %}text-danger{% endif %}">
                            <span class="d-inline-block px-2 py-1 rounded" 
                                  style="background-color: {% if f.tipo == 'Ingreso' %}#e6f7ed{% else %}#fde8e5{% endif %}">
                                ${{ f.monto|floatformat:2 }}
                            </span>
                        </td>
                        <td class="text-center">
                            <small class="text-muted">
                                {{ f.fecha|date:"d/m/Y" }}<br>
                                {% if f.fecha|date:"H:i" != "00:00" %}
                                {{ f.fecha|date:"H:i" }}
                                {% endif %}
                            </small>
                        </td>
                        <td class="text-center">
                            <span class="badge bg-light text-dark border border-dark-subtle rounded-pill">
                                <i class="fas fa-user-circle me-1"></i> {{ f.user.username|truncatechars:10 }}
                            </span>
                        </td>
                        <td>{{ f.descripcion|truncatechars:30|default:"-" }}</td>
                        <td>
                            <div class="d-flex gap-2">
                                <a href="{% url 'finanza_detail' f.id %}" class="btn btn-sm btn-outline-primary rounded-circle" title="Ver detalles">
                                    <i class="fas fa-eye"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="card-footer bg-light d-flex justify-content-between align-items-center">
            <div class="text-muted">
                Mostrando <span id="registrosMostrados">{{ finanza|length }}</span> de {{ finanza|length }} registros
            </div>
        </div>
    </div>
    {% else %}
    <div class="alert alert-info text-center py-5 border-0" style="background-color: #e6f3ff;">
        <i class="fas fa-wallet fa-4x mb-4" style="color: #1a73e8;"></i>
        <h4 class="alert-heading fw-bold" style="color: #1a73e8;">¡No hay finanzas registradas!</h4>
        <p class="text-muted">Parece que no has añadido ningún registro financiero todavía.</p>
        <hr style="border-top-color: #b3d1ff;">
        <a href="{% url 'create_finanza' %}" class="btn mt-3" style="background-color: #1a73e8; color: white;">
            <i class="fas fa-plus-circle me-2"></i> Crear Primer Registro
        </a>
    </div>
    {% endif %}
</div>

<!-- Incluir DataTables CSS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.2.2/css/buttons.dataTables.min.css">

<!-- Incluir jQuery y DataTables JS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>

<script>
$(document).ready(function() {
    // Inicializar DataTable sin paginación
    var table = $('#tablaFinanzas').DataTable({
        paging: false,
        info: false,
        dom: 'Bfrtip',
        buttons: [
            {
                extend: 'excel',
                text: '<i class="fas fa-file-excel"></i> Excel',
                className: 'btn-success btn-sm',
                title: 'Reporte_de_Finanzas',
                exportOptions: {
                    columns: [0, 1, 2, 3, 4, 5, 6, 7],
                    format: {
                        body: function(data, row, column, node) {
                            return $(data).text().trim() || data;
                        }
                    }
                }
            }
        ],
        language: {
            url: '//cdn.datatables.net/plug-ins/1.11.5/i18n/es-ES.json',
            search: "_INPUT_",
            searchPlaceholder: "Buscar en la tabla..."
        },
        responsive: true,
        initComplete: function() {
            $('.dataTables_filter input').addClass('form-control form-control-sm');
            $('.dataTables_filter label').contents().filter(function() {
                return this.nodeType === 3;
            }).remove();
        },
        drawCallback: function() {
            $('#registrosMostrados').text(this.api().rows({search: 'applied'}).count());
        }
    });
    
    // Aplicar filtros
    $('#filtroTitulo').on('keyup', function() {
        table.column(1).search(this.value).draw();
    });
    
    $('#filtroDescripcion').on('keyup', function() {
        table.column(7).search(this.value).draw();
    });
    
    $('#filtroTipo').on('change', function() {
        table.column(2).search(this.value).draw();
    });
    
    // Botón personalizado para exportar
    $('#btnExportExcel').on('click', function() {
        table.button('.buttons-excel').trigger();
    });
});
</script>

<style>
    body {
        background-color: #f8f9fa;
    }
    .card {
        border-radius: 12px;
        overflow: hidden;
        border: none;
    }
    .table {
        margin-bottom: 0;
    }
    .table thead th {
        border-bottom: 2px solid #dee2e6;
        text-transform: uppercase;
        font-size: 0.8rem;
        letter-spacing: 0.5px;
        background-color: #343a40;
        color: white;
    }
    .table tbody tr {
        transition: all 0.2s ease;
    }
    .table tbody tr:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    }
    .badge {
        font-weight: 500;
        padding: 0.4em 0.8em;
    }
    .input-group-text {
        background-color: white;
        border-right: none;
    }
    .form-control.border-start-0 {
        border-left: none;
    }
    .dt-buttons {
        display: none;
    }
    #btnExportExcel {
        border-radius: 8px;
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
        transition: all 0.2s;
    }
    @media (max-width: 768px) {
        .card-header {
            flex-direction: column;
            align-items: flex-start;
        }
        .card-header h5 {
            margin-bottom: 10px;
        }
        .table-responsive {
            border: none;
        }
    }
    .text-success {
        color: #2e8b57 !important;
    }
    .text-danger {
        color: #c23b22 !important;
    }
    .btn-outline-primary.rounded-circle {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .dataTables_wrapper .dataTables_filter {
        margin-bottom: 10px;
    }
    .dataTables_wrapper .dataTable {
        width: 100% !important;
    }
</style>
{% endblock %}