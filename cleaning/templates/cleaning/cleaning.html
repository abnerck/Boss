{% extends 'base.html' %}
{% block content %}
{% csrf_token %}


<style>
    :root {
        --primary-neon: #00bcd4;
        --secondary-neon: #ff2079;
        --accent-neon: #a0ff00;
        --dark-background: #0f1c2d;
        --card-background: rgba(18, 30, 48, 0.9);
        --text-light: #e0e6ed;
        --border-color: rgba(0, 188, 212, 0.3);
        --shadow-color: rgba(0, 188, 212, 0.5);
    }

    body {
        font-family: 'Rajdhani', sans-serif;
        background-color: var(--dark-background);
        color: var(--text-light);
        margin: 20px;
        padding-left: 280px;
    }

    .cyber-title {
        font-family: 'Orbitron', sans-serif;
        color: var(--primary-neon);
        text-shadow: 0 0 15px var(--primary-neon);
        margin-bottom: 1.5rem;
        position: relative;
        display: inline-block;
        padding-bottom: 10px;
        font-size: 2.5rem;
        text-align: center;
        width: 100%;
    }

    .cyber-title::after {
        content: '';
        position: absolute;
        left: 25%;
        bottom: 0;
        width: 50%;
        height: 3px;
        background: linear-gradient(to right, transparent, var(--primary-neon), var(--secondary-neon), transparent);
    }

    .cyber-panel {
        background: var(--card-background);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        box-shadow: 0 0 30px var(--shadow-color);
        padding: 2rem;
        margin: 2rem 0;
        position: relative;
        overflow: hidden;
        z-index: 1;
    }

    .cyber-panel::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(45deg,
                rgba(0, 188, 212, 0.05),
                rgba(255, 32, 121, 0.05));
        z-index: -1;
    }

    .progress-container {
        text-align: center;
        margin: 2rem 0;
    }

    #percentage {
        font-size: 2rem;
        font-weight: bold;
        font-family: 'Orbitron', sans-serif;
        padding: 1.5rem;
        border-radius: 10px;
        border: 2px solid var(--border-color);
        background: rgba(15, 28, 45, 0.8);
        transition: all 0.3s ease;
        text-shadow: 0 0 10px currentColor;
        box-shadow: 0 0 20px rgba(0, 188, 212, 0.3);
        position: relative;
        overflow: hidden;
    }

    #percentage::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
        transition: left 0.5s;
    }

    #percentage:hover::before {
        left: 100%;
    }

    .section {
        margin-bottom: 2rem;
        background: var(--card-background);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 0 20px rgba(0, 188, 212, 0.2);
        position: relative;
    }

    .section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 3px;
        background: linear-gradient(90deg, var(--primary-neon), var(--secondary-neon));
    }

    h2 {
        background: rgba(0, 188, 212, 0.2);
        color: var(--primary-neon);
        padding: 1rem;
        margin: 0;
        font-family: 'Orbitron', sans-serif;
        text-shadow: 0 0 10px var(--primary-neon);
        border-bottom: 1px solid var(--border-color);
    }

    table {
        width: 100%;
        border-collapse: collapse;
        background: rgba(15, 28, 45, 0.6);
    }

    th {
        background: rgba(0, 188, 212, 0.3);
        color: var(--primary-neon);
        padding: 1rem;
        text-align: left;
        font-family: 'Orbitron', sans-serif;
        font-weight: 600;
        border-bottom: 2px solid var(--border-color);
    }

    td {
        padding: 1rem;
        border-bottom: 1px solid rgba(0, 188, 212, 0.1);
        color: var(--text-light);
    }

    tr:hover {
        background: rgba(0, 188, 212, 0.05);
    }

    .daily {
        background: rgba(0, 188, 212, 0.1);
        border-left: 3px solid var(--primary-neon);
    }

    .biweekly {
        background: rgba(255, 32, 121, 0.1);
        border-left: 3px solid var(--secondary-neon);
    }

    .activity-checkbox {
        transform: scale(1.3);
        margin-right: 10px;
        accent-color: var(--accent-neon);
    }

    .status-indicator {
        margin-left: 10px;
        font-size: 0.9rem;
        font-weight: bold;
        padding: 0.3rem 0.8rem;
        border-radius: 15px;
        text-transform: uppercase;
    }

    .status-completed {
        color: var(--accent-neon);
        background: rgba(160, 255, 0, 0.1);
        border: 1px solid var(--accent-neon);
        text-shadow: 0 0 5px var(--accent-neon);
    }

    .status-pending {
        color: var(--secondary-neon);
        background: rgba(255, 32, 121, 0.1);
        border: 1px solid var(--secondary-neon);
        text-shadow: 0 0 5px var(--secondary-neon);
    }

    .status-saving {
        color: var(--primary-neon);
        background: rgba(0, 188, 212, 0.1);
        border: 1px solid var(--primary-neon);
        text-shadow: 0 0 5px var(--primary-neon);
    }

    .status-error {
        color: #ff4444;
        background: rgba(255, 68, 68, 0.1);
        border: 1px solid #ff4444;
        text-shadow: 0 0 5px #ff4444;
    }

    .loading {
        opacity: 0.6;
        pointer-events: none;
        position: relative;
    }

    .loading::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 20px;
        height: 20px;
        margin: -10px 0 0 -10px;
        border: 2px solid var(--primary-neon);
        border-top: 2px solid transparent;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .info-text {
        text-align: center;
        font-style: italic;
        color: var(--text-light);
        opacity: 0.8;
        margin-top: 2rem;
        padding: 1rem;
        border-top: 1px solid var(--border-color);
    }

    .scanlines {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(to bottom,
                transparent 50%,
                rgba(160, 255, 0, 0.02) 51%,
                transparent 52%);
        background-size: 100% 4px;
        pointer-events: none;
        z-index: -1;
        animation: scanline 10s infinite linear;
    }

    @keyframes scanline {
        0% { transform: translateY(-100%); }
        100% { transform: translateY(100%); }
    }

    .cyber-button {
        background: linear-gradient(45deg, var(--primary-neon), var(--secondary-neon));
        color: var(--dark-background);
        padding: 0.8rem 1.5rem;
        border: none;
        border-radius: 5px;
        font-family: 'Orbitron', sans-serif;
        font-weight: 600;
        text-decoration: none;
        text-shadow: 0 0 5px rgba(160, 255, 0, 0.8);
        transition: all 0.3s ease;
        box-shadow: 0 0 15px rgba(0, 188, 212, 0.3);
        cursor: pointer;
        display: inline-block;
        margin: 0.5rem;
    }

    .cyber-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 0 25px rgba(0, 188, 212, 0.5);
    }

    @media (max-width: 992px) {
        body {
            padding-left: 0;
            margin: 10px;
        }
        
        .cyber-title {
            font-size: 1.8rem;
        }
        
        .cyber-panel {
            padding: 1rem;
            margin: 1rem 0;
        }
        
        table {
            font-size: 0.9rem;
        }
        
        th, td {
            padding: 0.8rem;
        }
    }
</style>

<div class="scanlines"></div>

<div class="cyber-panel" data-aos="fade-up">
    <h1 class="cyber-title">PROGRAMA DE LIMPIEZA - EDIFICIO BOSS ({{ current_day }})</h1>
    <p style="text-align: center; font-size: 1.1rem; color: var(--text-light);">
        Actividades para hoy: <strong style="color: var(--accent-neon);">{{ total_activities }}</strong> totales. 
        Marca las completadas para ver el % en tiempo real.
    </p>
</div>

<div class="progress-container">
    <div id="percentage">
        {% with completed=0 %}
        {% for area_activities in grouped.values %}
            {% for activity in area_activities %}
                {% if activity.is_completed %}
                    {% with completed=completed|add:1 %}
                    {% endwith %}
                {% endif %}
            {% endfor %}
        {% endfor %}
        {{ completed|default:0 }}/{{ total_activities }} - {{ completed|default:0|floatformat:0 }}% COMPLETADO
        {% endwith %}
    </div>
</div>

{% for area, tasks in grouped.items %}
    <div class="section" data-aos="fade-up">
        <h2>
            {% if area == 'Departamentos Desocupados' %}
                <i class="fas fa-building"></i> {{ libres }} DEPARTAMENTOS DESOCUPADOS
            {% else %}
                <i class="fas fa-th-large"></i> {{ area|upper }}
            {% endif %}
        </h2>
        <table>
            <thead>
                <tr>
                    <th>ACTIVIDAD</th>
                    <th>PERIODICIDAD</th>
                    <th>REGISTRO (MARCAR COMPLETADO)</th>
                </tr>
            </thead>
            <tbody>
                {% for task in tasks %}
                    <tr class="{{ task.css_class }}">
                        <td>{{ task.task }}</td>
                        <td>
                            <span style="color: {% if task.frequency == 'Diaria' %}var(--primary-neon){% else %}var(--secondary-neon){% endif %}; 
                                  font-weight: bold;">
                                {{ task.frequency }}
                            </span>
                        </td>
                        <td>
                            <input type="checkbox" 
                                   class="activity-checkbox"
                                   data-activity-id="{{ task.id }}"
                                   {% if task.is_completed %}checked{% endif %}>
                            <span class="status-indicator {% if task.is_completed %}status-completed{% else %}status-pending{% endif %}" 
                                  id="status-{{ task.id }}">
                                {% if task.is_completed %}✅ GUARDADO{% else %}⏳ PENDIENTE{% endif %}
                            </span>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% empty %}
    <div class="cyber-panel" data-aos="fade-up">
        <p style="text-align: center; color: var(--accent-neon); font-size: 1.2rem;">
            <i class="fas fa-coffee"></i> No hay actividades programadas para hoy ({{ current_day }}). ¡Descansa!
        </p>
    </div>
{% endfor %}

{% if user.is_staff or user.is_superuser %}
<div style="text-align: center; margin: 2rem 0;">
    <a href="{% url 'cleaning_reports' %}" class="cyber-button">
        <i class="fas fa-chart-bar"></i> VER REPORTES DE ADMINISTRADOR
    </a>
</div>
{% endif %}

<p class="info-text">
    Nota: Los registros se guardan en la base de datos. Puedes ver el historial en el admin de Django.
</p>

<script>
    function updateProgressBar(completed, total, percentage) {
        const elem = document.getElementById('percentage');
        elem.innerHTML = `${completed}/${total} - ${percentage}% COMPLETADO`;
        
        // Colores según el porcentaje con estilo cyberpunk
        if (percentage === 100) {
            elem.style.color = 'var(--accent-neon)';
            elem.style.borderColor = 'var(--accent-neon)';
            elem.style.boxShadow = '0 0 30px rgba(160, 255, 0, 0.5)';
        } else if (percentage >= 80) {
            elem.style.color = 'var(--primary-neon)';
            elem.style.borderColor = 'var(--primary-neon)';
            elem.style.boxShadow = '0 0 25px rgba(0, 188, 212, 0.4)';
        } else if (percentage >= 50) {
            elem.style.color = 'var(--secondary-neon)';
            elem.style.borderColor = 'var(--secondary-neon)';
            elem.style.boxShadow = '0 0 20px rgba(255, 32, 121, 0.3)';
        } else {
            elem.style.color = '#ff4444';
            elem.style.borderColor = '#ff4444';
            elem.style.boxShadow = '0 0 15px rgba(255, 68, 68, 0.3)';
        }
    }

    function updateActivityStatus(checkbox) {
        const activityId = checkbox.dataset.activityId;
        const isCompleted = checkbox.checked;
        
        // Mostrar estado de carga
        checkbox.classList.add('loading');
        const statusIndicator = document.getElementById(`status-${activityId}`);
        statusIndicator.textContent = '⏳ GUARDANDO...';
        statusIndicator.className = 'status-indicator status-saving';
        
        // Enviar solicitud AJAX a tu endpoint save/
        fetch('{% url "save_log" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                activity_id: activityId,
                completed: isCompleted
            })
        })
        .then(response => response.json())
        .then(data => {
            checkbox.classList.remove('loading');
            
            if (data.success) {
                statusIndicator.textContent = isCompleted ? '✅ GUARDADO' : '⏳ PENDIENTE';
                statusIndicator.className = `status-indicator ${isCompleted ? 'status-completed' : 'status-pending'}`;
                
                // Actualizar la barra de progreso con los datos del servidor
                updateProgressBar(data.completed_count, data.total_count, data.percentage);
            } else {
                statusIndicator.textContent = '❌ ERROR';
                statusIndicator.className = 'status-indicator status-error';
                checkbox.checked = !isCompleted;
                
                // Mostrar alerta con estilo cyberpunk
                showCyberAlert('Error al guardar: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            checkbox.classList.remove('loading');
            statusIndicator.textContent = '❌ ERROR DE CONEXIÓN';
            statusIndicator.className = 'status-indicator status-error';
            checkbox.checked = !isCompleted;
            showCyberAlert('Error de conexión. Intenta nuevamente.', 'error');
        });
    }

    function showCyberAlert(message, type) {
        // Crear alerta con estilo cyberpunk
        const alertDiv = document.createElement('div');
        alertDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--card-background);
            color: ${type === 'error' ? '#ff4444' : 'var(--accent-neon)'};
            padding: 1rem 2rem;
            border: 1px solid ${type === 'error' ? '#ff4444' : 'var(--accent-neon)'};
            border-radius: 5px;
            box-shadow: 0 0 20px ${type === 'error' ? 'rgba(255, 68, 68, 0.5)' : 'rgba(160, 255, 0, 0.5)'};
            z-index: 1000;
            font-family: 'Orbitron', sans-serif;
            font-weight: bold;
            text-shadow: 0 0 5px currentColor;
        `;
        alertDiv.textContent = message;
        document.body.appendChild(alertDiv);
        
        // Remover después de 3 segundos
        setTimeout(() => {
            alertDiv.remove();
        }, 3000);
    }

    // Configurar event listeners cuando la página cargue
    document.addEventListener('DOMContentLoaded', function() {
        const checkboxes = document.querySelectorAll('.activity-checkbox');
        
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                updateActivityStatus(this);
            });
        });
        
        // Calcular progreso inicial
        let completedCount = 0;
        checkboxes.forEach(checkbox => {
            if (checkbox.checked) completedCount++;
        });
        
        const totalCount = checkboxes.length;
        const percentage = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;
        updateProgressBar(completedCount, totalCount, percentage);
        
        // Efecto de escritura para el título
        const title = document.querySelector('.cyber-title');
        const originalText = title.textContent;
        title.textContent = '';
        
        let charIndex = 0;
        const typingSpeed = 50;
        
        function typeText() {
            if (charIndex < originalText.length) {
                title.textContent += originalText.charAt(charIndex);
                charIndex++;
                setTimeout(typeText, typingSpeed);
            }
        }
        
        typeText();
    });
</script>
{% endblock %}